# üêç Django + uv Production Dockerfile
FROM python:3.12-slim

# üîß –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ uv
RUN pip install uv

# üë§ –°–æ–∑–¥–∞–Ω–∏–µ non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN useradd --create-home --shell /bin/bash app
WORKDIR /app

# üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY pyproject.toml uv.lock ./
RUN uv sync --frozen --no-dev

# üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
COPY --chown=app:app . .

# üóÇÔ∏è –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏ –ø—Ä–∞–≤–∞
RUN uv run python manage.py collectstatic --noinput
RUN chown -R app:app /app

# üë§ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ non-root
USER app

# üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PATH –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è .venv –Ω–∞–ø—Ä—è–º—É—é
ENV PATH="/app/.venv/bin:$PATH"

# üåê –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–∞
EXPOSE 8080

# üöÄ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è Cloud Run
CMD ["sh", "-c", "gunicorn botbalance.wsgi:application --bind 0.0.0.0:${PORT:-8080} --workers 2 --threads 4 --timeout 120 --graceful-timeout 30 --keep-alive 65 --log-level info"]
