# Step 6 · Auto Rebalance (Spot)

## Цель
Автоматический тик стратегии каждые ~30 секунд: рассчитывать действия и выставлять/обновлять ордера по политике исполнения.

## Алгоритм тика (упрощённо)
1) Получить портфель и цены (PriceService) → план (движок)
2) Обновить статусы активных ордеров (poll) и синхронизировать БД
3) Для каждой пары:
   - Если есть активный ордер:
     - Если требуется противоположная сторона → cancel и place
     - Если сторона прежняя:
       - Если статус NEW — можно переставить (cancel→place)
       - Если PARTIALLY_FILLED — не трогаем
   - Если активного нет и `|delta| ≥ min_delta_quote` — place
4) Логирование решений (decision log), снапшот портфеля (throttled)

## Бэкенд
- Celery Beat: задача `strategy_tick(user)`/batch по пользователям
- Redis‑лок per‑user — опционально (включать при параллелизме)
- Использовать те же сервисы: `rebalance_service`, `price_service`, `snapshot_service`

## Политики (из архитектуры)
- Один активный ордер на пару
- PARTIALLY_FILLED не отменяем до смены стороны
- NEW можно переставлять в ту же сторону

## Мониторинг/логи
- Decision Log: входы (NAV, цены), действия (side/qty/price), исход (order ids)
- Метрики: время тика, количество ордеров, ошибок, ретраев

## Тесты
- Интеграционный дымовой прогон на testnet (один юзер)
- Проверка смены стороны приводит к cancel→place
- NEW переставляется; PARTIALLY_FILLED сохраняется
