# Step 6 · Auto Rebalance (Spot)

## Цель
Автоматический тик стратегии каждые ~30 секунд: рассчитывать действия и выставлять/обновлять ордера по политике исполнения.

## Алгоритм тика
1. Собрать портфель и цены (через PriceService) → вычислить план (движок).
2. Обновить статусы активных ордеров (poll) и синхронизировать БД.
3. Для каждой пары:
   - Если есть активный ордер:
     - Если `side` требует смены и цена ушла дальше чем (order_price ± order_step/4) → cancel и place противоположный.
     - Если `side` прежний:
       - Если статус NEW — не переставляем.
       - Если PARTIALLY_FILLED — не трогаем.
   - Если нет активного ордера и `|delta| ≥ min_delta_quote` — place новый ордер.
4. Логирование решений (decision log), снапшот портфеля (throttled)

## Бэкенд
- Celery Beat: задача `strategy_tick(user)`/batch по пользователям
- Redis‑лок per‑user — опционально (включать при параллелизме)
- Использовать те же сервисы: `rebalance_service`, `price_service`, `snapshot_service`

## Мониторинг/логи
- Decision Log: входы (NAV, цены), действия (side/qty/price), исход (order ids)
- Метрики: время тика, количество ордеров, ошибок, ретраев

## Тесты
- Интеграционный дымовой прогон на testnet (один юзер)
- Проверка смены стороны приводит к cancel→place (читай архитектуру)
- NEW переставляется (читай архитектуру); PARTIALLY_FILLED сохраняется
