# üöÄ Infrastructure Description

## üéØ –¶–µ–ª—å

–ü–æ–¥–Ω—è—Ç—å –ø—Ä–æ–¥-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è botbalance, –Ω–µ —Ç—Ä–æ–≥–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É:

- **API** (Django+DRF) –∏ **Celery worker** ‚Äî –≤ Cloud Run
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** ‚Äî Cloud SQL (PostgreSQL)  
- **–û—á–µ—Ä–µ–¥—å/–∫—ç—à** ‚Äî Upstash Redis (serverless)
- **–§—Ä–æ–Ω—Ç–µ–Ω–¥** (Vite build) ‚Äî Google Cloud Storage + HTTPS
- **–î–æ–º–µ–Ω—ã**: `api.botbalance.me` (Cloud Run), `app.botbalance.me` (GCS)
- **–°–µ–∫—Ä–µ—Ç—ã** ‚Äî Google Secret Manager
- **CI/CD** ‚Äî GitHub Actions (–¥–≤–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞: CI —É–∂–µ –µ—Å—Ç—å; –¥–æ–±–∞–≤–ª—è–µ–º CD)

> **üìù –°—Ç–∞—Ç—É—Å**: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–∂–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç CI. –ó–∞–¥–∞—á–∞ ‚Äî –¥–æ–≤–µ—Å—Ç–∏ –µ–≥–æ –¥–æ ¬´–∫–Ω–æ–ø–∫–∏ –¥–µ–ø–ª–æ–π¬ª, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤ GCP –∏ –¥–æ–º–µ–Ω—ã.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è)

### Cloud Run
- **`botbalance-api`** ‚Äî –≤–µ–±-—Å–µ—Ä–≤–∏—Å DRF (gunicorn/uvicorn)
- **`botbalance-worker`** ‚Äî Celery worker (—Ç–æ—Ç –∂–µ –æ–±—Ä–∞–∑, –¥—Ä—É–≥–æ–π command)

### –•—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö
- **Cloud SQL (Postgres)** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Cloud Run ‚Üí Cloud SQL (instance connection)
- **Upstash Redis** ‚Äî –±—Ä–æ–∫–µ—Ä Celery –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫—ç—à

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏  
- **Google Secret Manager** ‚Äî —Å–µ–∫—Ä–µ—Ç—ã: `DJANGO_SECRET_KEY`, `DATABASE_URL`/DB creds, `REDIS_URL`, `ENCRYPTION_KEY`, `SENTRY_DSN` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- **Artifact Registry** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ backend
- **Cloud Storage bucket** ‚Äî —Ö–æ—Å—Ç–∏–Ω–≥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç) + HTTPS (—á–µ—Ä–µ–∑ LB –∏–ª–∏ Cloudflare)

### –î–æ–º–µ–Ω—ã
- `api.botbalance.me` ‚Üí Cloud Run (Managed SSL)
- `app.botbalance.me` ‚Üí GCS (—á–µ—Ä–µ–∑ HTTPS LB –∏–ª–∏ —á–µ—Ä–µ–∑ Cloudflare)

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–º–∏–Ω–∏–º—É–º, –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)

- **–°–µ–∫—Ä–µ—Ç—ã** ‚Äî —Ç–æ–ª—å–∫–æ –≤ Secret Manager, –¥–æ—Å—Ç—É–ø –ø–æ IAM –∫ Cloud Run —Å–µ—Ä–≤–∏—Å–∞–º
- **API-–∫–ª—é—á–∏ –±–∏—Ä–∂** (–∫–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è) ‚Äî —à–∏—Ñ—Ä–æ–≤–∞—Ç—å –≤ –ë–î —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–º –∫–ª—é—á–æ–º (`ENCRYPTION_KEY`), –∫–æ—Ç–æ—Ä—ã–π –ª–µ–∂–∏—Ç –≤ Secret Manager  
- **Cloud Run ‚Üí Cloud SQL** ‚Äî —á–µ—Ä–µ–∑ instance connection (`--add-cloudsql-instances`), –±–µ–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ IP –ë–î
- **CORS API**: —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–ª—å–∫–æ `https://app.botbalance.me`
- **CI/CD –¥–æ—Å—Ç—É–ø –∫ GCP** ‚Äî service account JSON –∫–∞–∫ GitHub Secret (–±—ã—Å—Ç—Ä–µ–µ) –∏–ª–∏ OIDC (–ª—É—á—à–µ, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ). –î–ª—è MVP ‚Äî JSON

> **üí° –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**: –ü–æ–¥—Ö–æ–¥ —Å JSON service account –∫–ª—é—á–æ–º –ø—Ä–æ—â–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ, –Ω–æ –º–µ–Ω–µ–µ –±–µ–∑–æ–ø–∞—Å–µ–Ω. OIDC Workload Identity Federation ‚Äî best practice –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.

## üîÅ –î–µ–ø–ª–æ–π (–∫–∞–∫ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å)

**–¢—Ä–∏–≥–≥–µ—Ä**: –ü—É—à–∏—à—å —Ç–µ–≥ —Ä–µ–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `v0.1.0`) –∏–ª–∏ –º–µ—Ä–∂–∏—à—å –≤ `main`.

**GitHub Actions –ø—Ä–æ—Ü–µ—Å—Å**:

1. üèóÔ∏è **–°–±–æ—Ä–∫–∞ backend –æ–±—Ä–∞–∑–∞** ‚Üí –ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Artifact Registry
2. üóÑÔ∏è **–ü—Ä–æ–≥–æ–Ω –º–∏–≥—Ä–∞—Ü–∏–π** (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω—ã–π job)  
3. üöÄ **–î–µ–ø–ª–æ–π Cloud Run**: `botbalance-api` –∏ `botbalance-worker`
4. üåê **–°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–∞** ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –≤ GCS bucket (—Å –∫—ç—à-–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏)

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
- ‚úÖ `https://api.botbalance.me/api/health` ‚Äî OK
- ‚úÖ `https://app.botbalance.me` ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, Dashboard –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ `/api/health`

## ‚úÖ Definition of Done

- [ ] –û–±–∞ —Å–µ—Ä–≤–∏—Å–∞ Cloud Run –Ω–∞ –º–µ—Å—Ç–µ, –∑–¥–æ—Ä–æ–≤—ã (health OK)
- [ ] Cloud SQL —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ Cloud Run, –±–µ–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
- [ ] Redis (Upstash) –ø–æ–¥–∫–ª—é—á—ë–Ω, Celery worker –∞–∫—Ç–∏–≤–µ–Ω
- [ ] `api.botbalance.me` –∏ `app.botbalance.me` —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ HTTPS
- [ ] –°–µ–∫—Ä–µ—Ç—ã –≤ Secret Manager, —Ä–æ–ª–∏ –Ω–∞ —Å–µ—Ä–≤–∏—Å-–∞–∫–∫–∞—É–Ω—Ç–µ –≤—ã–¥–∞–Ω—ã –º–∏–Ω–∏–º–∞–ª—å–Ω–æ  
- [ ] GitHub Actions CD ‚Äî –¥–µ–ø–ª–æ–π ¬´–æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π¬ª (–ø–æ —Ç–µ–≥—É / merge)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Ç–∫–∞—Ç (rollback –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –æ–±—Ä–∞–∑—É)

> **üéØ –ò—Ç–æ–≥**: –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø—É–Ω–∫—Ç–æ–≤ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –¥–µ–ø–ª–æ—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–µ–∫—Ä–µ—Ç–∞–º–∏.